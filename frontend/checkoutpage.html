<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
   <link rel="stylesheet" href="checkoutpage.css">
   <link rel="stylesheet" href="newsletter-modal.css">
  
  <title>Checkout</title>
  
  <style>
    .visually-hidden {
      position: absolute;
      left: -10000px;
      top: auto;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }
    input[type="number"] {
      -webkit-user-select: none;
      user-select: none;
    }
  </style>
</head>

    <body class= "">
    <section class= "index-logo">
        <div class= "wrapper">
            <h1>thutis'</h1>

<form id="homepageSearchForm">
  <input type="text" id="homepageSearchInput" placeholder="Search for products..." />
    <button type="submit">Search</button>
   <button type="button" id="micBtn" class="micBtn" title="Speak">
    üé§
  </button>
</form>

 <a href= "mainshop.html" input type= "button" class= "shopnowbtn" id= "shopnowbtn" onclick= "shopNav()" placeholder= "Shop now">Shop now</a>
         
            <header>
                <div class="icon-cart">
                    <svg  aria-hidden="true" xmlns="http://w ww.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 4h1.5L9 16m0 0h8m-8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm-8.5-3h9.25L19 7H7.312"/>
                    </svg>
                         <span>0</span>  
                </div>
            </header>
    </div>
        </section>
    
<!------Home Ribbon------>
<section class="index-topnav">
  <div class="wrapper">
    <div class="topnav" id="myTopnav">

   <div class="topnav-left">
      <a href="index.html" class="home">Home</a>

      <!-- This is always visible on nav (even on toggle) -->
      <div class="dropdown always-visible">
        <button class="dropbtn">Department ‚ñæ</button>
        <div class="dropdown-content">
          <a href="mainshop.html">Shop Everything</a>
          <a href="vegetables.html">Vegetable Department</a>
          <a href="chicken.html">Chicken Department</a>
          <a href="dogfood&tissues.html">Households</a>
        </div>
      </div>
   </div>

      <!-- Collapsible links (for mobile/hamburger toggle) -->
      <div class="collapsible-links">
         <a href= "aboutus.html" class= "about" id= "about" >About us</a>                       
        <a href="contactus.html">Contact Us</a>
        <a href="#tradinghours">Trading hours</a>
      </div>

      <a href="javascript:void(0);" class="icon" onclick="toggleMenu()">
        <i class="fa fa-bars"></i>
      </a>

    </div>
  </div>
</section>
                          
      <section> 
  <div class="locator" id="locator">
    <h5>
      <a href="index.html" id="index">DEPARTMENT</a> >> 
      <a href="#" id="back" onclick="history.back(); return false;">Back</a> >>  
     <u>CheckOut</u>
    </h5>
  </div>
</section>

  <div id="preloader">
  <img src="images/logo slogan-fotor-bg-remover-202503272309.png" alt="Loading..." id="loader-logo" />
                 <div class="loader-text">Please bear with me...</div>
</div>
  </div>
  <div class="row">
    <div class="col-75">
      <div class="container">
        <form id="checkoutForm">
          <div class="row">
            <div class="col-50">
              <h3>Billing Address</h3>

              <label for="fname">Full Name</label>
              <input type="text" id="fname" name="fname" placeholder="John M. Doe" autocomplete="name" required>

              <label for="email">Email</label>
              <input type="email" id="email" name="email" placeholder="john@example.com" autocomplete="email" required>

              <label for="adr">Address</label>
              <input type="text" id="adr" name="adr" placeholder="542 W. 15th Street" autocomplete="street-address" required>

              <div class="row-inline">
                <div class="col-50">
                  <label for="city">City</label>
                  <input type="text" id="city" name="city" placeholder="New York" autocomplete="address-level2" required>
                </div>
                <div class="col-50">
                  <label for="zip">Zip</label>
                  <input type="text" id="zip" name="zip" placeholder="10001" autocomplete="postal-code" required>
                </div>
              </div>
            </div>
          </div>

          <label><input type="checkbox" checked> Shipping address same as billing</label>
          <button type="submit" id="payButton"  class="btn">Pay Now</button>
        </form>
      </div>
    </div>

    <div class="col-25">
      <div class="checkout-container">
        <div class="checkout-summary">
          <h2>Receipt</h2>
          <div class="cart-header">
            <span>Products</span>
            <span>Quantity</span>
            <span>Total</span>
          </div>
          <div id="cartItems"></div>
          <div class="summary">
            <div><span>Subtotal:</span><span id="subtotal">R0.00</span></div>
            <div><span>Total:</span><span id="totalAmount">R0.00</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

       <!-- Placeholder to load modal -->
<div id="modalContainer"></div>

     <div class= "cartTab">
    <h1> Shopping Cart </h1>
    <div class= "listCart">
        <div class= "item">
          <!---- <div class= "image">
                <img src= "images/Red Peppers Real Box-fotor-bg-remover-2025040613110.png" alt= "">
            </div>
            <div class= "name">
                NAME
            </div>
            <div class= "totalPrice">
                R40
            </div>
            <div class= "quantity">
                <span class= "minus"> < </span>
                <span> 1 </span>
                <span class= "plus"> > </span>
            </div> ---->
        </div>
    </div>
         <div class="cart-grandtotal"></div>
    <div class= "btn">
        <button class= "close"> CLOSE </button>
        <button><a href= "cartPage.html" class= "checkOut"> CartPage</a></button>
    </div>
</div>
    </div>
</div>

    <!-----Social Media----->   
              <!--------MyAccount (Dropdown)------->
        <section class="footer-socialmedia">
            <div class= "footer-wrapper">
            <div class= "myaccountdropdown" id= "myaccountdropdown">
                <h2>Self Service</h2>
            <a href= "cartPage.html">Cart </a>
            <a href= "checkoutpage.html" class= "checkout" id= "checkout"> CheckOut </a>
            <a href= "contactus.html" class= "contactus">Contact Us</a>
        <a href= "javascript:void(0);" class= "icon" onclick= "myAccount()">
            <i class="fa fa-plus"></i>
        </a>
        <a href= "javascript:void(0);" class= "icon1" onclick= "myAccount()">
            <i class="fa fa-minus"></i>
        </a>
        </div>

        <!-----MyAccount----->
        <div class= "footer-content">
            <h2 class="selfserv">Self Service</h2>
            <ul class= "selfserv-list">               
            <li><a href="cartPage.html" class= "cart" id= "cart" onclick= "cartNav()">Cart</a></li> 
            <li><a href="checkoutpage.html" class= "checkout" id= "checkout" onclick= "checkoutNav()">CheckOut</a></li>
            <li><a href= "contactus.html" class= "contactus">Contact Us</a></li>
        </ul>
            </div>

            <!------information AboutUs (DropDown)----->
            <div class= "informationdropdown" id= "Informationdropdown">  
                <h2>Information</h2>
                <a href= "#" class="subscribeBtn">Subscribe to our NewsLetters</a>
                <a href= "readourpolicy.html" class= "readourpolicy">Read our Policy</a>
                <a href= "privatepolicy.html" class= "privatepolicy">Privacy Policy</a>
                <a href= "refundreturn-policy.html" class= "refundreturn-policy">Refund/Return Policy</a>
                <a href= "termsandconditions.html" id= "termsandconditions" class= "termsandconditions">Terms and Conditions</a>
                <a href= "javascript:void(0);" class= "icon" onclick= "information()">
                    <i class="fa fa-plus"></i>
                </a>
                <a href= "javascript:void(0);" class= "icon1" onclick= "information()">
                    <i class="fa fa-minus"></i>
                </a>
            </div>

            <!------Information AboutUs----->
            <div class= "footer-content">
            <h2>Information</h2>
        <ul class="info-list">
            <li><a href= "#index-signup" class= "newslettters">Subscribe to our NewsLetters</a></li>
            <li><a href= "readourpolicy.html" class= "readourpolicy">Read our Policy</a></li>
            <li><a href= "privatepolicy.html" class= "privatepolicy">Privacy Policy</a></li>
            <li><a href= "refundreturn-policy.html" class= "refundreturn-policy">Refund/Return Policy</a></li>
            <li><a href= "termsandconditions.html" id= "termsandconditions" class= "termsandconditions">Terms and Conditions</a></li>
    </ul>
    </div>

       <!-----FindUs (Dropdown)----->
       <div class= "findusdropdown" id="findusdropdown">
        <h2> Customer Care </h2>
        <h4><a href="tel:+27671837207" class="call" onclick="callNav()">067 183 7207</a></h4>
        <h4><a href= "https://mail.google.com/mail/?view=cm&fs=1&to=youribfo@thutisproject.com" class="email" onclick= "emailNav()">info@thutisproject.com</a></h4>
        <h4><a href= "https://www.google.com/maps?q=972 Extension 1 M20 Hebron Road, Soshanguve South, Pretoria, 0152, South Africa" target="_blank"> Address: <br> 972 Extension 1 M20 Hebron Road,<br> Soshanguve South, Pretoria, 0152,<br> South Africa </a></h4>
</div>

    <!-----FindUs----->
    <div class= "footer-content">
        <div class="customercare">
            <h2> Customer Care </h2>
            <ul>
            <p><li><a href= "tel:+27671837207"  alt= "Phone Numbers" id= "phonenumbers" onclick= "phonenumbersNav()">067 183 7207</a></li></p>
            <p><li><a href= "https://mail.google.com/mail/?view=cm&fs=1&to=info@thutisproject.com" alt= "E-mail" id= "email" onclick= "emailNav()">info@thutisproject.com</a></li></p>
            <p><li><a href= "https://www.google.com/maps?q=972 Extension 1 M20 Hebron Road, Soshanguve South, Pretoria, 0152, South Africa" alt= "Address" id= "address" onclick= "addressNav()">Address:<br>
972 Extension 1 M20 Hebron Road,<br> Soshanguve South, Pretoria, 0152,<br> South Africa</a></li></p>
        </ul>
</div>
</div>
                
        <div class= "footer-content">
        <div class= "social-icons">
            <h2> Follow Us </h2>
        <a href=""><i class= "fa fa-facebook" id= "fa fa-facebook"></i>Facebook</a>
        <a href=""><i class= "fa fa-twitter" id= "fa fa-twitter"></i>Twitter</a>
        <a href=""><i class= "fa fa-google" id= "fa fa-google"></i>google</a>
</div>
</div>

<div class= "footer-content-icons">
    <div class= "social-icons">
        <h2> Follow Us </h2>
    <a href=""><i class= "fa fa-facebook" id= "fa-facebook"></i></a>
    <a href=""><i class= "fa fa-twitter" id= "fa fa-twitter"></i></a>
    <a href=""><i class= "fa fa-google" id= "fa fa-google"></i></a>
</div>
</div>

<div class= "footer-content">
<div class= "tradinghours">
    <hr/>
    <h2> Trading Hours </h2>
<p>Mon-Sat: 07h00 - 17h30 </p>
<p>Sun: 07h00 - 14h00 </p>
</div>
</div>

    
</section>

<!--------Footer------>
<section>
<div class= "button-bar">
                <p>&copy; 2025 Thuti's Project. All rights reserved.</p></div>
</section>       
                <section class="footer-developer">
            <div class= "developer">
            <h5>Developed by <a href= "Kamogelo Kwetsane" class="developer" id= "developer" onclick= "developerNav()">Kamogelo Ronald Kwetsane</h5></a>
            </div>
        </section>

<script src="https://js.paystack.co/v1/inline.js"></script>
  <script>

        
    let products = [];
    const micBtn = document.getElementById('micBtn');
const searchInput = document.getElementById('homepageSearchInput');
    const iconCart = document.querySelector('.icon-cart');
const iconCartSpan = document.querySelector('.icon-cart span');
const closeCart = document.querySelector('.close');
const body = document.querySelector('body');
const listCartHTML = document.querySelector('.listCart');

    // ‚è≥ Preloader
window.addEventListener('load', () => {
  const preloader = document.getElementById('preloader');
  const content = document.getElementById('content');
  preloader.style.transition = 'opacity 0.5s ease';
  preloader.style.opacity = '0';
  setTimeout(() => {
    preloader.style.display = 'none';
    content.style.display = 'block';
  }, 500);
});

// üîç Search Form Handler
document.getElementById('homepageSearchForm')?.addEventListener('submit', function (e) {
    e.preventDefault();
    const searchValue = searchInput?.value.trim();
    if (searchValue) {
        window.location.href = `mainshop.html?search=${encodeURIComponent(searchValue)}`;
    }
});

      window.addEventListener('load', function () {
    const preloader = document.getElementById('preloader');
    const content = document.getElementById('content');

    preloader.style.transition = 'opacity 0.5s ease';
    preloader.style.opacity = '0';

    setTimeout(() => {
      preloader.style.display = 'none';
      content.style.display = 'block';
    }, 500);
  });

    iconCart?.addEventListener('click', (e) => {
    e.preventDefault();
    if (window.innerWidth <= 800) {
        window.location.href = 'cartPage.html';
    } else {
        body.classList.toggle('showCart');
    }
});

    closeCart?.addEventListener('click', () => {
    body.classList.remove('showCart');
});

    const fetchFiles = [
        'mainshop-products.json',
        'vegetable-products.json',
        'chicken-products.json',
        'dogfood&tissues-products.json'
    ];

    async function loadAllProducts() {
      products = [];
      for (const file of fetchFiles) {
        try {
          const resp = await fetch(file);
          const data = await resp.json();
          products.push(...data);
        } catch (e) {
          console.error('Error loading', file, e);
        }
      }
    }

    async function initCart() {
      await loadAllProducts();
      loadCart();
    }

    function loadCart() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const enriched = cart.map((ci, idx) => {
        const product = products.find(p => p.id == ci.product_id);
        return product ? { ...ci, product, origIndex: idx } : null;
      }).filter(x => x !== null);

      enriched.sort((a, b) =>
        a.product.name.localeCompare(b.product.name, undefined, { sensitivity: 'base' })
      );

      const container = document.getElementById('cartItems');
      container.innerHTML = '';
      let total = 0;

      enriched.forEach(ci => {
        const { product, quantity, origIndex } = ci;
        const itemTotal = product.price * quantity;
        total += itemTotal;

        const div = document.createElement('div');
        div.className = 'cartItems';
        div.innerHTML = `
          <div class="product">
            <img src="${product.image}" alt="${product.name}" />
            <div class="itemName">${product.name}</div>
            <div class="itemQuantity">
              <label for="qty-${origIndex}" class="visually-hidden">Quantity for ${product.name}</label>
              <input type="number" id="qty-${origIndex}" min="1" value="${quantity}"
                onchange="updateQuantity(${origIndex}, this.value)" readonly aria-label="Quantity of ${product.name}" />
            </div>
            <div class="itemTotal">R${itemTotal.toFixed(2)}</div>
          </div>
        `;
        container.appendChild(div);
      });

      document.getElementById('subtotal').textContent = `R${total.toFixed(2)}`;
      document.getElementById('totalAmount').innerHTML = `<strong>R${total.toFixed(2)}</strong>`;

              // Update cart icon count
const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
const cartCountSpan = document.querySelector('.icon-cart span');
if (cartCountSpan) {
  cartCountSpan.textContent = cartCount;
}
    }

    function updateQuantity(idx, newValue) {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const qty = parseInt(newValue);
      if (!isNaN(qty) && qty > 0 && cart[idx]) {
        cart[idx].quantity = qty;
        localStorage.setItem('cart', JSON.stringify(cart));
        loadCart();
      }
    }

(async () => {
  if (!products.length) {
    await loadAllProducts();
  }
})();
    
function calculateCartTotal() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      let total = 0;
      cart.forEach(item => {
        const product = products.find(p => p.id == item.product_id);
        if (product) {
          total += product.price * item.quantity;
        }
      });
      return total;
    }

    async function handlePaystackPayment() {
      // Validate form and cart
      const email = document.getElementById('email')?.value;
      const name = document.getElementById('fname')?.value;
      if (!email || !name) {
        alert('Please fill out name and email');
        return;
      }

      const amount = calculateCartTotal();
      if (amount <= 0) {
        alert('Your cart is empty.');
        return;
      }

      // You may want to **initialize** a transaction on your backend first,
      // to generate a reference or secure data server-side, before calling Paystack.
      // For now, we‚Äôll do the ‚Äúclient-only‚Äù flow:

      const handler = PaystackPop.setup({
        key: 'pk_test_029e565b987849508edf44a50f214c87bca573af',  // üîÅ Replace with your Paystack public key
        email: email,
        amount: amount * 100,  // Paystack expects the amount in the smallest currency unit
        currency: "ZAR",  // or "NGN", etc.
        ref: `TXREF_${Date.now()}`,  // optional transaction reference
        metadata: {
          custom_fields: [
            { display_name: "Customer Name", variable_name: "customer_name", value: name }
          ]
        },
callback: function(response) {
  const ref = response.reference;

  fetch(`${BASE_URL}/api/verify-and-save-order`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      payment_reference: ref,
      customer_name: name,
      customer_email: email,
      address: `${address}, ${city}, ${zip}`,
      cart: cartArray,   // must be array, not string
      total: total.toFixed(2)
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert("‚úî Payment verified & order saved!");
      localStorage.removeItem("cart");
      window.location.reload();
    } else {
      alert("‚ö† Verification failed: " + data.message);
    }
  })
  .catch(err => {
    console.error(err);
    alert("‚ùå Server error while verifying payment.");
  });
},
        onClose: function() {
          alert('Transaction was cancelled.');
        }
      });

      handler.openIframe();
    }

  async function sendOrderToBackend(paymentReference) {
  try {
    const name = document.getElementById('fname').value;
    const email = document.getElementById('email').value;
    const address = document.getElementById('adr').value;
    const city = document.getElementById('city').value;
    const zip = document.getElementById('zip').value;
    const cart = JSON.parse(localStorage.getItem('cart')) || [];

    await loadAllProducts();

    const cartArray = cart.map(item => {
      const product = products.find(p => p.id == item.product_id);
      return product
        ? {
            product_id: item.product_id,
            name: product.name,
            quantity: item.quantity,
            price: product.price
          }
        : null;
    }).filter(Boolean);

    const total = cartArray.reduce((sum, item) => sum + item.price * item.quantity, 0);

    const payload = {
      customer_name: name,
      customer_email: email,
      address: `${address}, ${city}, ${zip}`,
      cart: cartText,               // array instead of string
      total: total.toFixed(2),
      payment_reference: paymentReference
    };

    const resp = await fetch(`${BASE_URL}/api/send-order`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await resp.json();
    if (data.success) {
      alert("‚úÖ Order placed and recorded!");
      localStorage.removeItem("cart");
      window.location.reload();
    } else {
      console.warn("Backend error:", data.message);
      alert("‚ö†Ô∏è Payment succeeded, but order save failed.");
    }
  } catch (err) {
    console.error("Order submission error:", err);
    alert("‚ùå Failed to record order. Try again.");
  }
}

    // Initialize cart and products
    initCart();

    // üñºÔ∏è Render Cart HTML
const addCartToHTML = () => {
    if (!iconCartSpan) return;

    let totalQuantity = 0;
    let grandTotal = 0;
    listCartHTML.innerHTML = '';

    const fullCartItems = carts.map(cart => {
        const product = allProducts.find(p => p.id === cart.product_id);
        return product ? { ...cart, product } : null;
    }).filter(Boolean);

    fullCartItems.sort((a, b) => a.product.name.localeCompare(b.product.name));

    fullCartItems.forEach(cart => {
        const { product, quantity } = cart;
        const totalPrice = product.price * quantity;
        totalQuantity += quantity;
        grandTotal += totalPrice;

        const item = document.createElement('div');
        item.className = 'item';
        item.dataset.id = cart.product_id;
        item.innerHTML = `
            <div class="image"><img src="${product.image}" alt=""></div>
            <div class="name">${product.name}</div>
            <div class="totalPrice">R${totalPrice}</div>
            <div class="quantity">
                <span class="minus"> < </span>
                <span>${quantity}</span>
                <span class="plus"> > </span>
            </div>
        `;
        listCartHTML.appendChild(item);
    });

    iconCartSpan.innerText = totalQuantity;

    const grandTotalDiv = document.querySelector('.cart-grandtotal');
    if (grandTotalDiv) {
        grandTotalDiv.innerHTML = `
            <hr/>
            <div class="totalRow">
                <strong>Total:</strong>
                <span>R${grandTotal}</span>
            </div>
        `;
    }
}

// ‚ûï‚ûñ Modify Quantity
const changeQuantity = (product_id, type) => {
    const index = carts.findIndex(item => item.product_id === product_id);
    if (index >= 0) {
        if (type === 'plus') {
            carts[index].quantity += 1;
        } else if (type === 'minus') {
            carts[index].quantity -= 1;
            if (carts[index].quantity <= 0) {
                carts.splice(index, 1);
            }
        }
        addCartToMemory();
        addCartToHTML();
    }
};

// üõí Add to Cart
function addToCart(product_id) {
    const index = carts.findIndex(item => item.product_id === product_id);
    if (index !== -1) {
        carts[index].quantity += 1;
    } else {
        carts.push({ product_id, quantity: 1 });
    }
    addCartToMemory();
    addCartToHTML();
}

// ‚ùå Clear Cart
function clearCart() {
    carts = [];
    addCartToMemory();
    addCartToHTML();
    speak("Cart cleared");
}

// üé§ Speak
function speak(text) {
    const synth = window.speechSynthesis;
    const utter = new SpeechSynthesisUtterance(text);
    synth.speak(utter);
}

// üñ±Ô∏è Quantity Click Handler
document.addEventListener('click', (e) => {
    const item = e.target.closest('.listCart .item');
    const product_id = item?.dataset?.id;
    if (!product_id) return;

    if (e.target.classList.contains('minus')) {
        changeQuantity(product_id, 'minus');
    } else if (e.target.classList.contains('plus')) {
        changeQuantity(product_id, 'plus');
    }
});

// üõí Cart Icon Click (Responsive)
iconCart?.addEventListener('click', (e) => {
    e.preventDefault();
    if (window.innerWidth <= 800) {
        window.location.href = 'cartPage.html';
    } else {
        body.classList.toggle('showCart');
    }
});

// ‚ùå Close Cart Sidebar
closeCart?.addEventListener('click', () => {
    body.classList.remove('showCart');
});

// üîÑ Cart Sync Across Tabs
window.addEventListener('storage', (event) => {
    if (event.key === 'cart') {
        const storedCart = localStorage.getItem('cart');
        if (storedCart) {
            carts = JSON.parse(storedCart);
            addCartToHTML();
        }
    }
});

 document.getElementById("checkoutForm").addEventListener("submit", function (event) {
  event.preventDefault();        // ‚õî stops page refresh
  handlePaystackPayment();       // ‚úÖ opens Paystack
});

// üöÄ Init App
const initApp = async () => {
    await loadAllProducts();
    const storedCart = localStorage.getItem('cart');
    if (storedCart) {
        carts = JSON.parse(storedCart);
    }
    addCartToHTML();
};

document.addEventListener('DOMContentLoaded', () => {
    initApp();
});

// üé§ Voice Recognition
if ('webkitSpeechRecognition' in window && micBtn) {
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    micBtn.addEventListener('click', () => {
        recognition.start();
        micBtn.disabled = true;
       micBtn.innerHTML = 'üéôÔ∏è <span class="listening-text">Listening...</span>';
    });

    recognition.onresult = (event) => {
        const spoken = event.results[0][0].transcript.toLowerCase().trim();
        micBtn.disabled = false;
        micBtn.innerText = 'üé§';

        if (spoken.includes('check out') || spoken.includes('checkout')) {
            speak("Going to checkout");
            setTimeout(() => window.location.assign('cartPage.html'), 1000);
        } else if (spoken.includes('show cart')) {
            document.body.classList.add('showCart');
            speak("Showing cart");
        } else if (spoken.includes('close cart')) {
            document.body.classList.remove('showCart');
            speak("Closing cart");
        } else if (spoken.startsWith('add ')) {
            const name = spoken.replace('add ', '').replace('to cart', '').trim();
            const match = allProducts.find(p => p.name.toLowerCase().includes(name));
            if (match) {
                addToCart(match.id);
                speak(`Added ${match.name} to cart`);
            } else {
                speak(`Couldn't find ${name}`);
            }
        } else if (spoken.includes('clear cart')) {
            clearCart();
        } else {
            // Default: Search
            searchInput.value = spoken;
            speak(`Searching for ${spoken}`);
            setTimeout(() => {
                window.location.href = `mainshop.html?search=${encodeURIComponent(spoken)}`;
            }, 1000);
        }
    };

    recognition.onerror = () => {
        micBtn.disabled = false;
        micBtn.innerText = 'üé§';
        speak("Voice recognition error");
    };

    recognition.onend = () => {
        micBtn.disabled = false;
        micBtn.innerText = 'üé§';
    };
} else {
    console.warn("Voice recognition not supported.");
}

function removeItemByName(name) {
  // Make sure cart and product data are loaded
  if (!Array.isArray(carts) || !Array.isArray(allProducts)) return;

  // Find the cart item that matches by product name (case-insensitive)
  const index = carts.findIndex(item => {
    const product = allProducts.find(p => p.id === item.product_id);
    return product && product.name.toLowerCase().includes(name.toLowerCase());
  });

  // If found, remove it and update UI + storage
  if (index !== -1) {
    const removedProduct = allProducts.find(p => p.id === carts[index].product_id);
    carts.splice(index, 1);
    addCartToMemory();   // Save to localStorage
    addCartToHTML();     // Update cart view
    if (typeof speak === 'function') {
      speak(`${removedProduct.name} removed from cart`);
    }
  } else {
    if (typeof speak === 'function') {
      speak(`No product found matching "${name}"`);
    }
  }
}

// Handles dropdown click for ALL screen sizes
document.querySelectorAll(".dropdown .dropbtn").forEach(btn => {
  btn.addEventListener("click", function(e) {

    // Stop navigation
    e.preventDefault();
    e.stopPropagation();

    const dropdown = this.parentElement;

    // Close other open dropdowns
    document.querySelectorAll(".dropdown.open").forEach(d => {
      if (d !== dropdown) d.classList.remove("open");
    });

    // Toggle current dropdown
    dropdown.classList.toggle("open");
  });
});

// Close dropdown when clicking outside
document.addEventListener("click", function() {
  document.querySelectorAll(".dropdown.open").forEach(d => d.classList.remove("open"));
});

function toggleMenu() {
  const nav = document.getElementById('myTopnav');  // or whatever element is your nav
  if (nav) {
    nav.classList.toggle('responsive');
  }
}

 let lastScrollTop = 0;
  const locator = document.querySelector('.locator');

  window.addEventListener('scroll', function () {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

    if (scrollTop > lastScrollTop) {
      // Scrolling down
      locator.style.transform = 'translateY(-200%)'; // hide
    } else {
      // Scrolling up
      locator.style.transform = 'translateY(0)'; // show
    }

    lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
  }, false);

// üîò Navigation Dropdowns
function myFunction() {
    const x = document.getElementById("myTopnav");
    x.className = x.className === "topnav" ? "topnav responsive" : "topnav";
}

function information() {
    const x = document.getElementById("Informationdropdown");
    x.className = x.className === "informationdropdown" ? "informationdropdown responsive" : "informationdropdown";
}

function myAccount() {
    const x = document.getElementById("myaccountdropdown");
    x.className = x.className === "myaccountdropdown" ? "myaccountdropdown responsive" : "myaccountdropdown";
}

// Toggle dropdowns
function toggleDropdown(id) {
    const el = document.getElementById(id);
    if (el) el.classList.toggle("responsive");
}

// ‚≠ê AUTO-CLOSE NAV + DROPDOWN ON SCROLL
window.addEventListener("scroll", () => {
    const topnav = document.getElementById("myTopnav");
    const dropdown = document.querySelector(".dropdown");

    // Close hamburger
    if (topnav && topnav.classList.contains("responsive")) {
        topnav.classList.remove("responsive");
    }

    // Close dropdown
    if (dropdown && dropdown.classList.contains("open")) {
        dropdown.classList.remove("open");
    }
});

// ‚≠ê AUTO-CLOSE DROPDOWN WHEN HAMBURGER OPENS
const topnav = document.getElementById("myTopnav");
const dropdownBtn = document.querySelector(".dropdown .dropbtn");
const dropdownBox = document.querySelector(".dropdown");

function closeHamburger() {
    if (topnav.classList.contains("responsive")) {
        topnav.classList.remove("responsive");
    }
}

function closeDropdown() {
    if (dropdownBox.classList.contains("open")) {
        dropdownBox.classList.remove("open");
    }
}

// When YOU OPEN the dropdown ‚Üí close hamburger
dropdownBtn?.addEventListener("click", () => {
    // dropdown toggling happens in your existing code
    // So just close hamburger AFTER toggle
    setTimeout(() => {
        if (dropdownBox.classList.contains("open")) {
            closeHamburger();
        }
    }, 50);
});

// When YOU OPEN hamburger ‚Üí close dropdown
function myFunction() {
    topnav.classList.toggle("responsive");

    // If hamburger just opened, close dropdown
    if (topnav.classList.contains("responsive")) {
        closeDropdown();
    }
}

document.addEventListener("DOMContentLoaded", () => {
  // Load the modal HTML dynamically
  fetch("newsletter-modal.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("modalContainer").innerHTML = html;
      setupNewsletterModal();
    })
    .catch(err => console.error("Modal failed to load:", err));
});

function setupNewsletterModal() {
  const modal = document.getElementById("newsletterModal");
  const closeBtn = modal.querySelector(".close");
  const form = modal.querySelector("#newsletterForm");
  const thankYou = modal.querySelector("#thankYouMessage");
  const existsMsg = modal.querySelector("#existsMessage");

  // Handle ALL .subscribeBtn buttons across page
  document.querySelectorAll(".subscribeBtn").forEach(btn => {
    btn.addEventListener("click", e => {
      e.preventDefault();
      modal.classList.add("show");
    });
  });

  closeBtn.addEventListener("click", () => modal.classList.remove("show"));
  window.addEventListener("click", e => {
    if (e.target === modal) modal.classList.remove("show");
  });

  const getSubs = () => JSON.parse(localStorage.getItem("subscribers") || "[]");
  const saveSubs = subs => localStorage.setItem("subscribers", JSON.stringify(subs));

  form.addEventListener("submit", e => {
    e.preventDefault();
    const name = form.subscriberName.value.trim();
    const email = form.subscriberEmail.value.trim().toLowerCase();
    const subs = getSubs();

    thankYou.style.display = "none";
    existsMsg.style.display = "none";

    if (subs.includes(email)) {
      existsMsg.style.display = "block";
      return;
    }

    subs.push(email);
    saveSubs(subs);

    form.style.display = "none";
    thankYou.style.display = "block";

    setTimeout(() => {
      modal.classList.remove("show");
      thankYou.style.display = "none";
      form.style.display = "block";
      form.reset();
    }, 3000);
  });
}

  </script>
</body>
</html>
